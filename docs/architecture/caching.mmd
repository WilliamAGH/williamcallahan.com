graph TD
    subgraph "Write Pipeline"
        EXT[External Suppliers<br/>(Karakeep, GitHub, etc.)]
        JOB[Refresh Jobs / Scripts<br/>(cron, selective refresh)]
        S3[S3 JSON Source of Truth<br/>(bookmarks.json, github_stats_summary.json, ...)]
        EXT --> JOB --> S3
    end

    subgraph "Read Pipeline"
        RSC[Next.js Cache Components<br/>('use cache', cacheTag)]
        UI[Pages & RSC Consumers<br/>(bookmarks, blog, related-content, github)]
        API[API Routes<br/>(noStore, Cache-Control: no-store)]
        S3 --> RSC --> UI
        S3 --> API
    end

    subgraph "Supporting Layers"
        LEGACY[ServerCacheInstance<br/>Metadata-only Map cache]
        LOCK[Distributed Locking<br/>(S3 lock files)]
        RC[Request Coalescing]
        LEGACY --> UI
        LOCK --> JOB
        RC --> JOB
    end

    subgraph "Cache Tags & TTLs"
        TAG1[bookmarks / slug tags<br/>15-60 min]
        TAG2[blog / related-content<br/>~1-2 h]
        TAG3[github-activity<br/>~30 min]
        RSC --> TAG1
        RSC --> TAG2
        RSC --> TAG3
    end

    subgraph "API Exclusions"
        API --> EX[unstable_noStore()<br/>Cache-Control: no-store]
    end

    style S3 fill:#dff0d8,stroke:#2f6627,stroke-width:2px
    style RSC fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    style API fill:#fdecea,stroke:#b71c1c,stroke-width:2px
