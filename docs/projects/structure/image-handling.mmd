graph TD
    subgraph "Client/Server Request"
        A["/api/logo"]
        B["/api/og-image"]
        C["/api/cache/images"]
        D["Investment Cards<br/>(Server Components)"]
        E["Bookmark Cards<br/>(Client Components)"]
    end

    subgraph "Memory Management Layer"
        MM1["ImageMemoryManager<br/>512MB LRU Cache<br/>50MB per image"]
        MM2["UnifiedImageService<br/>Request Router<br/>Stream >5MB"]
        MM3["MemoryHealthMonitor<br/>Progressive Thresholds"]
        MM4["mem-guard.ts<br/>30s RSS Check"]
    end

    subgraph "Image Pipeline"
        F["Multi-Source<br/>Fetching"]
        G["Perceptual Hash<br/>Validation"]
        H["Processing<br/>Buffer.from()"]
        ST["Stream to S3<br/>(>5MB)"]
    end
    
    subgraph "Storage Tiers"
        I["Memory Cache<br/>~1ms"]
        J["S3 Storage<br/>~50ms"]
        K["CDN Delivery"]
    end
    
    subgraph "External Sources"
        L["External APIs<br/>(Google, Clearbit)<br/>100ms-5s"]
        M["OpenGraph<br/>Parsing"]
    end

    %% Request flows
    A --> MM2
    B --> MM2
    C --> MM2
    D --> MM2
    E --> B

    %% Memory management
    MM2 --> MM1
    MM1 -->|HIT| K
    MM1 -->|MISS| J
    J -->|HIT| MM1
    J -->|MISS| F
    
    %% Fetching pipeline
    F --> L
    F --> M
    L --> G
    G -->|Valid| H
    G -->|Invalid| K
    H -->|">5MB"| ST
    H -->|"<5MB"| MM1
    ST --> J
    
    %% Background persistence
    MM1 -.->|Background| J
    J --> K

    %% Memory pressure monitoring
    MM4 -->|"Monitor RSS"| MM3
    MM3 -->|"75% Warning"| MM2
    MM3 -->|"80% Reject Large"| MM1
    MM3 -->|"90% Critical"| A & B & C
    MM3 -->|"100% Clear Images"| MM1
    MM3 -->|"120% Emergency"| MM1 & I

    subgraph "Progressive Thresholds"
        T1["75% - Warning logs"]
        T2["80% - Reject large ops"]
        T3["90% - 503 responses"]
        T4["100% - Clear images"]
        T5["120% - Clear all"]
    end

    %% Styling
    classDef memory fill:#e3f2fd,stroke:#1976d2,stroke-width:3px
    classDef fast fill:#e8f5e9,stroke:#2e7d32
    classDef medium fill:#fff3e0,stroke:#ef6c00
    classDef slow fill:#ffebee,stroke:#c62828
    classDef critical fill:#ffcdd2,stroke:#d32f2f
    
    class MM1,MM2,MM3,MM4 memory
    class I fast
    class J medium
    class L,M slow
    class T3,T4,T5 critical