graph TD
    subgraph "Request Flow"
        A[API/Component Request]
        B{Cache Check}
        C["‚úÖ HIT<br/>~1ms"]
        D["‚ùå MISS"]
    end

    subgraph "Caching Layers" 
        L1["ServerCacheInstance<br/>Metadata Only<br/>(Map-based Cache)"]
        L1B["Next.js 15 'use cache'<br/>Native Caching<br/>(NEW)"]
        L2["ImageMemoryManager<br/>Deprecated<br/>(No caching)"]
        L3["S3 Storage<br/>~50ms"]
        L4["External APIs<br/>100ms-5s"]
    end
    
    subgraph "Migration Status"
        M1["‚úÖ MIGRATED (5 files)<br/>‚Ä¢ lib/search.ts<br/>‚Ä¢ lib/bookmarks/bookmarks-data-access.server.ts<br/>‚Ä¢ lib/data-access/github.ts<br/>‚Ä¢ lib/blog/mdx.ts<br/>‚Ä¢ lib/data-access/images.server.ts"]
        M2["‚ùå LEGACY (20+ files)<br/>‚Ä¢ lib/data-access/opengraph.ts<br/>‚Ä¢ lib/data-access/logos.ts<br/>‚Ä¢ lib/bookmarks/bookmarks.ts<br/>‚Ä¢ API routes<br/>‚Ä¢ Health endpoints"]
        M3["üîß MAP-BASED CACHE (3 files)<br/>‚Ä¢ lib/server-cache.ts<br/>‚Ä¢ lib/image-memory-manager.ts<br/>‚Ä¢ lib/blog/mdx.ts (cleanup needed)"]
    end
    
    subgraph "Advanced Patterns"
        RC["Request Coalescing<br/>(Share promises)"]
        DL["Distributed Lock<br/>(S3-based)"]
        NC["Negative Cache<br/>(Failed = 1-2hr)"]
    end

    subgraph "Memory Safety"
        MS1["No buffers in ServerCache"]
        MS2["10MB buffer rejection"]
        MS3["100k key limit"]
        MS4["Batch eviction 10%"]
    end

    A --> B
    B -->|HIT| C
    B -->|MISS| D
    
    D --> RC
    RC -->|New| L3
    RC -->|Waiting| RC
    
    L3 -->|Found| L1
    L3 -->|Miss| L4
    L4 --> NC
    NC --> L1
    
    L1 -.->|Images| L2
    L2 -.->|Buffers| C
    L1 -.->|Metadata| C

    subgraph "üî¥ Security Issue"
        SEC1["/api/cache/clear"]
        SEC2["NO AUTH!"]
        SEC3["DoS Risk"]
    end
    
    SEC1 --> SEC2
    SEC2 --> SEC3

    %% Styling
    style B fill:#e1f5fe
    style C fill:#d4edda,stroke:#155724
    style D fill:#f8d7da,stroke:#721c24
    style L2 fill:#e3f2fd,stroke:#1976d2,stroke-width:3px
    style SEC1 fill:#ffcdd2,stroke:#d32f2f
    style SEC2 fill:#ffcdd2,stroke:#d32f2f
    style SEC3 fill:#ffcdd2,stroke:#d32f2f