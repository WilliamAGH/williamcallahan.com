graph TD
    subgraph "Request Flow"
        A[API/Component Request]
        B{Cache Check}
        C["‚úÖ HIT<br/>~1ms"]
        D["‚ùå MISS"]
    end

    subgraph "Caching Layers" 
        L1["ServerCacheInstance<br/>Metadata Only<br/>(Map-based Cache)"]
        L1B["Next.js 15 'use cache'<br/>Native Caching<br/>(NEW)"]
        L2["ImageMemoryManager<br/>Deprecated<br/>(No caching)"]
        L3["S3 Storage<br/>~50ms"]
        L4["External APIs<br/>100ms-5s"]
    end
    
    subgraph "Cache Invalidation"
        INV1["/api/revalidate/bookmarks<br/>‚úÖ Authenticated"]
        INV2["revalidateTag()<br/>Programmatic"]
        INV3["Scheduler Trigger<br/>After S3 Update"]
        INV4["Cache Tags:<br/>‚Ä¢ bookmarks<br/>‚Ä¢ bookmarks-page-N<br/>‚Ä¢ bookmarks-tag-X<br/>‚Ä¢ search-index"]
    end
    
    subgraph "Migration Status"
        M1["‚úÖ MIGRATED (9 files)<br/>‚Ä¢ lib/search.ts<br/>‚Ä¢ lib/bookmarks/bookmarks-data-access.server.ts<br/>‚Ä¢ lib/data-access/github.ts<br/>‚Ä¢ lib/blog/mdx.ts<br/>‚Ä¢ lib/data-access/images.server.ts<br/>+ 4 API routes"]
        M2["‚ùå LEGACY (33 files)<br/>Using ServerCacheInstance<br/>‚Ä¢ lib/data-access/opengraph.ts<br/>‚Ä¢ lib/data-access/logos.ts<br/>‚Ä¢ API routes<br/>‚Ä¢ Health endpoints"]
        M3["üîß MAP-BASED (10 files)<br/>Direct Map usage<br/>‚Ä¢ lib/server-cache.ts<br/>‚Ä¢ lib/rate-limit.ts<br/>‚Ä¢ Session management"]
    end
    
    subgraph "Advanced Patterns"
        RC["Request Coalescing<br/>(Share promises)"]
        DL["Distributed Lock<br/>(S3-based)"]
        NC["Negative Cache<br/>(Failed = 1-2hr)"]
        SWR["Stale-While-Revalidate<br/>Serve old, fetch new"]
    end

    subgraph "Cache TTLs"
        TTL1["Bookmarks: 1hr"]
        TTL2["Pagination: 1 day"]
        TTL3["Logos: 30 days"]
        TTL4["GitHub: 24hr"]
        TTL5["Search: 15min"]
    end

    subgraph "Memory Safety"
        MS1["No buffers in ServerCache"]
        MS2["10MB buffer rejection"]
        MS3["100k key limit"]
        MS4["Batch eviction 10%"]
    end

    A --> B
    B -->|HIT| C
    B -->|MISS| D
    
    D --> RC
    RC -->|New| L3
    RC -->|Waiting| RC
    
    L3 -->|Found| L1
    L3 -->|Miss| L4
    L4 --> NC
    NC --> L1
    
    L1 -.->|Images| L2
    L2 -.->|No Cache| C
    L1 -.->|Metadata| C
    L1B -.->|JSON Data| C
    
    %% Invalidation Flow
    INV3 -->|POST| INV1
    INV1 -->|Calls| INV2
    INV2 -->|Clears| INV4
    INV4 -->|Invalidates| L1B

    subgraph "‚úÖ Security Fixed"
        SEC1["/api/cache/clear"]
        SEC2["x-api-key Auth"]
        SEC3["Protected"]
    end
    
    SEC1 --> SEC2
    SEC2 --> SEC3

    %% Styling
    style B fill:#e1f5fe
    style C fill:#d4edda,stroke:#155724
    style D fill:#f8d7da,stroke:#721c24
    style L1B fill:#e3f2fd,stroke:#1976d2,stroke-width:3px
    style INV1 fill:#d4edda,stroke:#155724
    style INV2 fill:#d4edda,stroke:#155724
    style SEC1 fill:#d4edda,stroke:#155724
    style SEC2 fill:#d4edda,stroke:#155724
    style SEC3 fill:#d4edda,stroke:#155724