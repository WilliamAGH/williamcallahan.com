# Code Block Architecture Map

## Overview

The `code-block` functionality provides interactive code display components with syntax highlighting, copy-to-clipboard features, and macOS-style window controls. It is designed to work within MDX content, supporting both standalone and embedded rendering modes.

### 2025-08 UI refinements (beast-mode modern pass)

- Improved container polish: subtle border + ring for depth in both themes
- Header tweaks: thicker padding and bottom border for definition; language chip legibility
- Typography: increased `pre` size to `text-[13px]` with `leading-relaxed`, consistent `font-mono`
- Copy button: glassy backdrop blur, higher contrast, subtle ring and shadow
- Inline code: rounded chip with ring-inset and slightly higher padding for readability
- SSR fallback: matches new sizing and typography for first paint parity

## Core Components and Responsibilities

- **code-block.client.tsx**
  - **Purpose**: Main client-side component for rendering code blocks.
  - **Responsibilities**:
    - Renders interactive UI with syntax highlighting using rehype-prism classes.
    - Provides copy-to-clipboard functionality via `CopyButton`.
    - Implements macOS-style window controls (minimize, maximize, close) using `WindowControls`.
    - Supports two modes: standalone (full window chrome) and embedded (minimal styling for tabs).
  - **Interactions**:
    - Uses `useWindowSize` hook for responsive control sizing.
    - Manages state for visibility, minimization, and maximization.
    - Processes SVG transforms within code content.
  - **UI Notes (2025-08)**:
    - Container uses `rounded-lg shadow-sm md:shadow-md border border-gray-200/80 dark:border-gray-800/80 ring-1 ring-black/5 dark:ring-white/5`.
    - Header has `px-3 py-2` and a subtle `border-b` for separation.
    - `pre` uses `text-[13px] leading-relaxed` with `font-mono` ensured via utility.

- **copy-button.client.tsx**
  - **Purpose**: Provides a button for copying code content to clipboard.
  - **Responsibilities**:
    - Handles clipboard operations with visual feedback (changes icon on copy success).
    - Dynamically positions itself based on code block height (centered for short code, top-right for longer code).
  - **Interactions**:
    - Appears on hover using Tailwind's `group-hover` utility.
    - Uses `navigator.clipboard` API for copy functionality.
  - **UI Notes (2025-08)**:
    - Button uses `backdrop-blur-sm`, dark translucent background, subtle ring/shadow, and `text-emerald-400` success state.

- **mdx-code-block-wrapper.client.tsx** & **mdx-code-block.server.tsx**
  - **Purpose**: Integration layer for MDX content.
  - **Responsibilities**:
    - `MDXCodeBlockFallback`: Server-side fallback for basic styling during SSR.
    - `MDXCodeBlock`: Client-side wrapper that hydrates with full `CodeBlock` functionality.
    - Handles context detection (e.g., embedded in tab frames) to adjust rendering.
    - Processes SVG transforms for code content.
  - **UI Notes (2025-08)**:
    - Fallback `pre` matches `text-[13px] leading-relaxed` and color balance for parity with hydrated state.
  - **Interactions**:
    - Wraps `CodeBlock` component for MDX integration.
    - Uses `processSvgTransforms` utility to fix SVG rendering issues.

- **prism-syntax-highlighting/prism.css**
  - **Purpose**: Custom styling for syntax highlighting.
  - **Responsibilities**:
    - Overrides default PrismJS styles to match project design.
    - Ensures visibility in both light and dark modes with appropriate color contrast.
  - **Interactions**:
    - Applied globally to all code blocks via classes generated by rehype-prism.
  - **UI Notes (2025-08)**:
    - Enforces `pre-wrap`, removes text-shadow, defers background to container; token palette tuned for both themes.

- **prism-syntax-highlighting/prism.js**
  - **Purpose**: Syntax highlighting library.
  - **Responsibilities**:
    - Provides tokenization and highlighting for multiple programming languages.
  - **Interactions**:
    - Used by rehype-prism during build time to generate highlighted HTML.

## Logic Flow

1. **MDX Processing**: MDX content with code blocks is processed at build time using rehype-prism, which applies PrismJS highlighting classes based on language.
2. **Server-Side Rendering**: `MDXCodeBlockFallback` renders basic styled `<pre>` elements during SSR for initial page load.
3. **Client-Side Hydration**: `MDXCodeBlock` replaces the fallback with the full `CodeBlock` component, adding interactivity.
4. **User Interaction**:
   - Users can copy code using `CopyButton`.
   - In standalone mode, users can minimize, maximize, or close the code block using `WindowControls`.
5. **Responsive Design**: Control sizes adjust based on window width using `useWindowSize` hook.
6. **Vertical Spacing**: Outer MDX article wraps code blocks in a `flex space-y-5` column which controls spacing; individual `<pre>` elements no longer set `mb-6`.
7. **Inline Code**: Inline `<code>` chips use `font-mono`, small rounded corners, and ring-inset for contrast without heavy borders.

## Key Interactions

- **CodeBlock** ↔ **CopyButton**: `CodeBlock` positions `CopyButton` within its layout, passing filtered content for copying.
- **CodeBlock** ↔ **WindowControls**: `CodeBlock` manages state for window controls, affecting its rendering mode.
- **MDXCodeBlock** ↔ **CodeBlock**: `MDXCodeBlock` wraps `CodeBlock`, providing context (e.g., embedded mode) from MDX structure.
- **Rehype-Prism** ↔ **PrismJS**: Build-time processing uses PrismJS logic to apply syntax highlighting classes to code content.

## Notes

- Syntax highlighting is applied at build time, reducing client-side JavaScript overhead.
- The design prioritizes accessibility with proper tabindex settings for keyboard navigation.
- SVG transform fixes are applied to ensure correct rendering of graphical code snippets.
