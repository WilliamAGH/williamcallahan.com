# Code Block Architecture Map

## Overview

The `code-block` functionality provides interactive code display components with syntax highlighting, copy-to-clipboard features, and macOS-style window controls. It is designed to work within MDX content, supporting both standalone and embedded rendering modes.

## Core Components and Responsibilities

- **code-block.client.tsx**
  - **Purpose**: Main client-side component for rendering code blocks.
  - **Responsibilities**:
    - Renders interactive UI with syntax highlighting using rehype-prism classes.
    - Provides copy-to-clipboard functionality via `CopyButton`.
    - Implements macOS-style window controls (minimize, maximize, close) using `WindowControls`.
    - Supports two modes: standalone (full window chrome) and embedded (minimal styling for tabs).
  - **Interactions**:
    - Uses `useWindowSize` hook for responsive control sizing.
    - Manages state for visibility, minimization, and maximization.
    - Processes SVG transforms within code content.

- **copy-button.client.tsx**
  - **Purpose**: Provides a button for copying code content to clipboard.
  - **Responsibilities**:
    - Handles clipboard operations with visual feedback (changes icon on copy success).
    - Dynamically positions itself based on code block height (centered for short code, top-right for longer code).
  - **Interactions**:
    - Appears on hover using Tailwind's `group-hover` utility.
    - Uses `navigator.clipboard` API for copy functionality.

- **mdx-code-block-wrapper.client.tsx** & **mdx-code-block.server.tsx**
  - **Purpose**: Integration layer for MDX content.
  - **Responsibilities**:
    - `MDXCodeBlockFallback`: Server-side fallback for basic styling during SSR.
    - `MDXCodeBlock`: Client-side wrapper that hydrates with full `CodeBlock` functionality.
    - Handles context detection (e.g., embedded in tab frames) to adjust rendering.
    - Processes SVG transforms for code content.
  - **Interactions**:
    - Wraps `CodeBlock` component for MDX integration.
    - Uses `processSvgTransforms` utility to fix SVG rendering issues.

- **prism-syntax-highlighting/prism.css**
  - **Purpose**: Custom styling for syntax highlighting.
  - **Responsibilities**:
    - Overrides default PrismJS styles to match project design.
    - Ensures visibility in both light and dark modes with appropriate color contrast.
  - **Interactions**:
    - Applied globally to all code blocks via classes generated by rehype-prism.

- **prism-syntax-highlighting/prism.js**
  - **Purpose**: Syntax highlighting library.
  - **Responsibilities**:
    - Provides tokenization and highlighting for multiple programming languages.
  - **Interactions**:
    - Used by rehype-prism during build time to generate highlighted HTML.

## Logic Flow

1. **MDX Processing**: MDX content with code blocks is processed at build time using rehype-prism, which applies PrismJS highlighting classes based on language.
2. **Server-Side Rendering**: `MDXCodeBlockFallback` renders basic styled `<pre>` elements during SSR for initial page load.
3. **Client-Side Hydration**: `MDXCodeBlock` replaces the fallback with the full `CodeBlock` component, adding interactivity.
4. **User Interaction**:
   - Users can copy code using `CopyButton`.
   - In standalone mode, users can minimize, maximize, or close the code block using `WindowControls`.
5. **Responsive Design**: Control sizes adjust based on window width using `useWindowSize` hook.

## Key Interactions

- **CodeBlock** ↔ **CopyButton**: `CodeBlock` positions `CopyButton` within its layout, passing filtered content for copying.
- **CodeBlock** ↔ **WindowControls**: `CodeBlock` manages state for window controls, affecting its rendering mode.
- **MDXCodeBlock** ↔ **CodeBlock**: `MDXCodeBlock` wraps `CodeBlock`, providing context (e.g., embedded mode) from MDX structure.
- **Rehype-Prism** ↔ **PrismJS**: Build-time processing uses PrismJS logic to apply syntax highlighting classes to code content.

## Notes

- Syntax highlighting is applied at build time, reducing client-side JavaScript overhead.
- The design prioritizes accessibility with proper tabindex settings for keyboard navigation.
- SVG transform fixes are applied to ensure correct rendering of graphical code snippets.
