graph LR
    %% Entry Points
    A["Storage Request"] --> B{Operation}
    
    %% Read Path
    B -->|Read| C{Content Type?}
    C -->|JSON| D["🚫 Direct S3<br/>(bypass CDN)"]
    C -->|Images| E["🚀 CDN First<br/>~50ms"]
    
    E --> F{CDN Hit?}
    F -->|Yes| G["Return Data"]
    F -->|No| H["S3 Fallback<br/>~100-200ms"]
    
    D --> I[S3Client.GetObject]
    H --> I
    I --> J["Return Data"]
    
    %% Write Path
    B -->|Write| K[Process Data]
    K --> L[S3Client.PutObject]
    L --> M["Configure ACL"]
    M --> N["Upload Complete<br/>~200-500ms"]
    
    %% Memory Integration
    subgraph "Memory Safety"
        MI1["Images → S3 immediately"]
        MI2["CDN URLs prevent loading"]
        MI3["Stream >5MB images"]
        MI4["Only metadata cached"]
    end
    
    %% Storage Organization
    subgraph "S3 Structure"
        S1["images/ - logos, general"]
        S2["opengraph/ - OG images"]
        S3["bookmarks/ - JSON data"]
        S4["github/ - activity data"]
    end
    
    %% Critical Issues
    subgraph "Issues"
        X1["⚠️ Full directory scans"]
        X2["⚠️ Race conditions"]
        X3["✅ ACL explicit (fixed)"]
        X4["✅ Retry logic (fixed)"]
    end
    
    %% Connect memory safety
    N --> MI1
    G --> MI2
    K --> MI3
    
    %% Styling
    style A fill:#e1f5fe
    style G fill:#e8f5e9
    style J fill:#fff3e0
    style N fill:#fce4ec
    style X1 fill:#ffebee
    style X2 fill:#ffebee
    style X3 fill:#c8e6c9
    style X4 fill:#c8e6c9