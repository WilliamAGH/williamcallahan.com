graph TD
    subgraph "External + Refresh"
        GHAPI[GitHub APIs<br/>(GraphQL + REST + CSV)]
        REF[Refresh Jobs / POST /api/github-activity/refresh]
        LOCK[Distributed Lock]
        GHAPI --> REF --> LOCK
    end

    subgraph "Source of Truth"
        S3[github_stats_summary*.json,<br/>activity_data.json,<br/>aggregated_weekly_activity.json,<br/>repo_raw_weekly_stats/]
        LOCK --> S3
    end

    subgraph "Consumers"
        CACHE[Next.js Cache Components<br/>(cacheTag("github-activity"), ~30 min)]
        UI[GitHub Activity pages<br/>(calendar, summary cards)]
        API[/api/github-activity<br/>noStore]
        S3 --> CACHE --> UI
        S3 --> API
    end

    subgraph "Supporting"
        MAPCACHE[ServerCacheInstance<br/>metadata only]
        HEALTH[/api/health/deep<br/>validates JSON freshness]
        SCHED[scheduler.ts / cron]
        REF <-- SCHED
        MAPCACHE --> UI
        S3 --> HEALTH
    end

    style S3 fill:#dff0d8,stroke:#2f6627,stroke-width:2
    style CACHE fill:#e3f2fd,stroke:#1976d2,stroke-width:2
    style API fill:#fdecea,stroke:#b71c1c,stroke-width:2
