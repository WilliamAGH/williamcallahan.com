graph TD
    subgraph "External & Refresh"
        KAR[Karakeep API]
        REFRESH[Selective Refresh Jobs<br/>(cron + API refresh endpoint)]
        LOCK[Distributed Lock<br/>(S3 lock file)]
        KAR --> REFRESH
        REFRESH --> LOCK
    end

    subgraph "Source of Truth"
        S3JSON[bookmarks-dev.json,<br/>index-dev.json,<br/>pages-dev/, tags-dev/, slug-mapping-dev.json]
        REFRESH --> S3JSON
    end

    subgraph "Consumers"
        CACHE[Next.js Cache Components<br/>("use cache", cacheTag)]
        UI_PAGES[Bookmark pages / tag pages / detail routes]
        RELCONTENT[Related Content & Search aggregators]
        API_ROUTES[/api/bookmarks,<br/>/api/search/*,<br/>/api/related-content*]<br/><br/>noStore()
        S3JSON --> CACHE --> UI_PAGES
        CACHE --> RELCONTENT
        S3JSON --> API_ROUTES
    end

    subgraph "Supporting Systems"
        MAPCACHE[ServerCacheInstance<br/>metadata only]
        OG_ENRICH[OpenGraph Enhancement + UnifiedImageService]
        HEALTH[/api/health/deep<br/>verifies slug + JSON integrity]
        MAPCACHE --> UI_PAGES
        OG_ENRICH --> REFRESH
        S3JSON --> HEALTH
    end

    subgraph "Cache Tags & TTLs"
        TAGS[bookmarks, bookmark-${slug}, bookmarks-tag-${slug}, related-content]
        CACHE --> TAGS
    end

    style S3JSON fill:#dff0d8,stroke:#2f6627,stroke-width:2px
    style CACHE fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    style API_ROUTES fill:#fdecea,stroke:#b71c1c,stroke-width:2px
