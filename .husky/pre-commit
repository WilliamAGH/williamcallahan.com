#!/usr/bin/env bash
set -euo pipefail

echo "üöÄ Running pre-commit checks on staged files..."

# Set up PATH to include bun, fall back to npx if bun not available
export PATH="$HOME/.bun/bin:$PATH"
if command -v bun >/dev/null 2>&1; then
  RUNNER_PREFIX=(bun x)
else
  echo "‚ÑπÔ∏è  Bun not found; falling back to npx."
  RUNNER_PREFIX=(npx)
fi

# Check for git lock file and fail safely instead of force-deleting
if [ -f .git/index.lock ]; then
  echo "‚ùå .git/index.lock exists. A Git process may be running."
  echo "   Resolve the lock (close other Git processes) and retry the commit."
  exit 1
fi

# Check if there are any staged files
if ! git diff --cached --name-only --diff-filter=ACMR | grep -q .; then
  echo "üì≠ No staged files to check"
  exit 0
fi

# Process staged files directly with pipes to preserve NUL delimiters
# Run oxlint on JS/TS files if any
if git diff --cached --name-only --diff-filter=ACMR -z | grep -zE '\.(js|jsx|ts|tsx)$' | grep -qz .; then
  echo "üîç Running oxlint on TypeScript/JavaScript files..."
  git diff --cached --name-only --diff-filter=ACMR -z | grep -zE '\.(js|jsx|ts|tsx)$' | xargs -0 "${RUNNER_PREFIX[@]}" oxlint --fix || {
    echo "‚ùå Oxlint found issues!"
    exit 1
  }
fi

# Run prettier on applicable files if any
if git diff --cached --name-only --diff-filter=ACMR -z | grep -zE '\.(js|jsx|ts|tsx|json|md|mdx|yml|yaml|css)$' | grep -qz .; then
  echo "‚ú® Running prettier on staged files..."
  git diff --cached --name-only --diff-filter=ACMR -z | grep -zE '\.(js|jsx|ts|tsx|json|md|mdx|yml|yaml|css)$' | xargs -0 "${RUNNER_PREFIX[@]}" prettier --write
  # Re-add files that were modified by prettier
  git diff --cached --name-only --diff-filter=ACMR -z | grep -zE '\.(js|jsx|ts|tsx|json|md|mdx|yml|yaml|css)$' | xargs -0 git add
fi

echo "‚úÖ Pre-commit checks passed!"
