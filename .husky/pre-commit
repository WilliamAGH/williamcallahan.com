#!/usr/bin/env sh
set -eu

echo "üöÄ Running pre-commit checks on staged files..."

# Set up PATH to include bun, fall back to npx if bun not available
export PATH="$HOME/.bun/bin:$PATH"
if command -v bunx >/dev/null 2>&1; then
  RUNNER="bunx"
elif command -v npx >/dev/null 2>&1; then
  echo "‚ÑπÔ∏è  Bun not found; falling back to npx."
  RUNNER="npx"
else
  echo "‚ùå Neither bunx nor npx is available in PATH."
  exit 1
fi

# Check if there are any staged files
if ! git diff --cached --name-only --diff-filter=ACMR | grep -q .; then
  echo "üì≠ No staged files to check"
  exit 0
fi

# Run oxlint on JS/TS files if any
if git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(js|jsx|ts|tsx)$' >/dev/null 2>&1; then
  echo "üîç Running oxlint on TypeScript/JavaScript files..."
  git diff --cached --name-only --diff-filter=ACMR | while IFS= read -r file; do
    case "$file" in
      *.js|*.jsx|*.ts|*.tsx) printf '%s\0' "$file" ;;
    esac
  done | xargs -0 "$RUNNER" oxlint --fix || {
    echo "‚ùå Oxlint found issues!"
    exit 1
  }
fi

# Run oxfmt on applicable files if any
if git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(js|jsx|ts|tsx|json|md|yml|yaml|css)$' >/dev/null 2>&1; then
  echo "‚ú® Running oxfmt on staged files..."
  git diff --cached --name-only --diff-filter=ACMR | while IFS= read -r file; do
    case "$file" in
      *.js|*.jsx|*.ts|*.tsx|*.json|*.md|*.yml|*.yaml|*.css) printf '%s\0' "$file" ;;
    esac
  done | xargs -0 "$RUNNER" oxfmt --write || {
    echo "‚ùå Oxfmt failed!"
    exit 1
  }

  # Re-add files that were modified by oxfmt
  git diff --cached --name-only --diff-filter=ACMR | while IFS= read -r file; do
    case "$file" in
      *.js|*.jsx|*.ts|*.tsx|*.json|*.md|*.yml|*.yaml|*.css) printf '%s\0' "$file" ;;
    esac
  done | xargs -0 git add --
fi

echo "‚úÖ Pre-commit checks passed!"
