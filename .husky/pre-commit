#!/usr/bin/env bash
set -euo pipefail

echo "üöÄ Running pre-commit checks on staged files..."

# Set up PATH to include bun, fall back to npx if bun not available
export PATH="$HOME/.bun/bin:$PATH"
if command -v bun >/dev/null 2>&1; then
  RUNNER_PREFIX=(bun x)
else
  echo "‚ÑπÔ∏è  Bun not found; falling back to npx."
  RUNNER_PREFIX=(npx)
fi

# Check for git lock file and fail safely instead of force-deleting
if [ -f .git/index.lock ]; then
  echo "‚ùå .git/index.lock exists. A Git process may be running."
  echo "   Resolve the lock (close other Git processes) and retry the commit."
  exit 1
fi

# Get list of staged files (NUL-delimited to handle spaces/newlines)
STAGED_FILES_NUL=$(git diff --cached --name-only --diff-filter=ACMR -z)

if [ -z "$STAGED_FILES_NUL" ]; then
  echo "üì≠ No staged files to check"
  exit 0
fi

# Filter staged files into buckets, NUL-safe
JS_TS_FILES_NUL=$(printf "%s" "$STAGED_FILES_NUL" | grep -zE '\.(js|jsx|ts|tsx)$' || true)
PRETTIER_FILES_NUL=$(printf "%s" "$STAGED_FILES_NUL" | grep -zE '\.(js|jsx|ts|tsx|json|md|mdx|yml|yaml|css)$' || true)

# Run oxlint on JS/TS files if any
if [ -n "${JS_TS_FILES_NUL:-}" ]; then
  echo "üîç Running oxlint on TypeScript/JavaScript files..."
  printf "%s" "$JS_TS_FILES_NUL" | xargs -0 "${RUNNER_PREFIX[@]}" oxlint --fix || {
    echo "‚ùå Oxlint found issues!"
    exit 1
  }
fi

# Run prettier on applicable files if any
if [ -n "${PRETTIER_FILES_NUL:-}" ]; then
  echo "‚ú® Running prettier on staged files..."
  printf "%s" "$PRETTIER_FILES_NUL" | xargs -0 "${RUNNER_PREFIX[@]}" prettier --write
  # Re-add files that were modified by prettier
  printf "%s" "$PRETTIER_FILES_NUL" | xargs -0 git add
fi

echo "‚úÖ Pre-commit checks passed!"
