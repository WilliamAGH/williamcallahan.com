echo "üöÄ Running pre-commit checks on staged files..."

# Set up PATH to include bun
export PATH="$HOME/.bun/bin:$PATH"

# Check for and remove stale git lock file if it exists
if [ -f .git/index.lock ]; then
  echo "‚ö†Ô∏è  Found stale git lock file, removing..."
  rm -f .git/index.lock
fi

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

if [ -z "$STAGED_FILES" ]; then
  echo "üì≠ No staged files to check"
  exit 0
fi

# Filter for JavaScript/TypeScript files
JS_TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|jsx|ts|tsx)$' || true)
# Filter for files that prettier can format
PRETTIER_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|jsx|ts|tsx|json|md|mdx|yml|yaml|css)$' || true)

# Run oxlint on JS/TS files if any
if [ -n "$JS_TS_FILES" ]; then
  echo "üîç Running oxlint on TypeScript/JavaScript files..."
  echo "$JS_TS_FILES" | xargs bun x oxlint --fix || {
    echo "‚ùå Oxlint found issues!"
    exit 1
  }
fi

# Run prettier on applicable files if any
if [ -n "$PRETTIER_FILES" ]; then
  echo "‚ú® Running prettier on staged files..."
  echo "$PRETTIER_FILES" | xargs bun x prettier --write
  # Re-add files that were modified by prettier
  echo "$PRETTIER_FILES" | xargs git add
fi

echo "‚úÖ Pre-commit checks passed!"
