#!/bin/sh
echo "ğŸš€ Running pre-push checks..."

# Get the range of commits being pushed
REMOTE_REF=$(git rev-parse @{u} 2>/dev/null || git rev-parse origin/$(git branch --show-current) 2>/dev/null || echo "HEAD~1")

# Flag to track if build is needed
BUILD_NEEDED=false

# Check if .next directory exists
if [ ! -d ".next" ]; then
  echo "âš ï¸  Build directory not found."
  BUILD_NEEDED=true
else
  # Check for chunk files
  CHUNK_COUNT=$(find .next/static/chunks -type f -name "*.js" 2>/dev/null | wc -l)

  if [ "$CHUNK_COUNT" -lt 5 ]; then
    echo "âš ï¸  Missing or insufficient chunk files detected (found: $CHUNK_COUNT)"
    BUILD_NEEDED=true
  else
    # Verify critical chunks exist
    CRITICAL_CHUNKS=(
      ".next/static/chunks/webpack.js"
      ".next/static/chunks/main-app.js"
      ".next/static/chunks/app-pages-internals.js"
    )

    for chunk in "${CRITICAL_CHUNKS[@]}"; do
      if [ ! -f "$chunk" ]; then
        echo "âš ï¸  Critical chunk missing: $chunk"
        BUILD_NEEDED=true
        break
      fi
    done
  fi
fi

# Run build if needed
if [ "$BUILD_NEEDED" = true ]; then
  echo "ğŸ”¨ Building application..."
  bun run build || { echo "âŒ Build failed!"; exit 1; }
else
  echo "âœ… Build artifacts are present"
fi

# Run validation
echo "ğŸ“ Validating code..."
bun run validate || { echo "âŒ Code validation failed!"; exit 1; }

# Run smoke tests
echo "ğŸ§ª Running smoke tests..."
bun run test:smoke || { echo "âŒ Smoke tests failed!"; exit 1; }

# Check bookmark integrity
echo "ğŸ” Checking bookmark integrity..."
bun run scripts/bookmark-diagnostics.ts integrity || { 
  echo "âŒ Bookmark integrity check failed!"
  echo "ğŸ“š Fix the bookmarks listed above before pushing."
  echo "ğŸ’¡ Run 'bun run scripts/bookmark-diagnostics.ts integrity' to see details."
  exit 1
}

echo "âœ… All pre-push checks passed!"